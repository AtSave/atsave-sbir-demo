<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ±å„„æ¯›å·¾æœ‰é™å…¬å¸ æ™ºæ…§èƒ½æ•ˆå¹³å°</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
  <!-- âœ… å…±ç”¨ç¶²ç«™é é¦–å€å¡Š -->
<header style="display: flex; align-items: center; justify-content: space-between; background-color: #ffffff; padding: 1rem 2rem; border-bottom: 1px solid #eee;">
  <div>
    <h1 style="color: #0077b6; margin: 0;">å®‰ç‰¹çœæœ‰é™å…¬å¸ æ™ºæ…§èƒ½æ•ˆå¹³å°</h1>
    <p style="margin: 0; color: #555;">æœ¬å¹³å°æ•´åˆè¨­å‚™ç›£æ§ã€ç¢³æ’è¨ˆç®—èˆ‡ ESG å ±è¡¨åŠŸèƒ½ï¼Œå”åŠ©å·¥å» æ•¸ä½è½‰å‹èˆ‡ç¯€èƒ½ç¢³ç®¡ç†ã€‚</p>
  </div>
  <div>
    <img src="img/atsave-logo.png" alt="ATSAVE LOGO" style="height: 48px;" />
  </div>
</header>

<body>
<!-- ğŸ”„ é›»åŠ›æ’ç¢³ä¿‚æ•¸é¡¯ç¤ºå€å¡Š -->
<div id="carbonFactorDisplay"
     style="position: fixed; top: 10px; right: 20px; font-size: 0.85rem; background: #eef; padding: 6px 12px; border-radius: 6px;">
  ğŸ”„ é›»åŠ›æ’ç¢³ä¿‚æ•¸ï¼š-- kg COâ‚‚e/kWhï¼ˆæœªè¨­å®šï¼‰
</div>

  <div class="container">
  <!-- ğŸ”· å®‰ç‰¹çœ LOGO -->
    <h1>ğŸŒ¿ æ±å„„æ¯›å·¾æœ‰é™å…¬å¸ æ™ºæ…§èƒ½æ•ˆç®¡ç†</h1>
    <p>æœ¬å¹³å°çµåˆè¨­å‚™ç›£æ§ã€ç¢³æ’è¨ˆç®—èˆ‡ ESG å ±è¡¨åŠŸèƒ½ï¼Œæä¾›è™å°¾å» äº”å°æ¯›å·¾ç”Ÿç”¢æ ¸å¿ƒè£½ç¨‹è¨­å‚™ä¹‹å³æ™‚èƒ½æ•ˆæ•¸æ“šã€‚<br/>
    åŒæ™‚æ”¯æ´æ­·å²æ•¸æ“šæŸ¥è©¢èˆ‡èƒ½è€—å„ªåŒ–åˆ†æï¼Œå”åŠ©å·¥å» æ•¸ä½è½‰å‹èˆ‡ç¢³ç®¡ç†ã€‚</p>

    <!-- ğŸ•’ ç¾åœ¨æ™‚é–“ -->
    <p style="text-align:right;">ğŸ•’ ç¾åœ¨æ™‚é–“ï¼š<span id="nowTime">--:--:--</span></p>

    <div style="text-align:right; margin-bottom:1rem;">
      <button onclick="location.href='history.html'">ğŸ“‹ æŸ¥è©¢æ­·å²è³‡æ–™</button>
      <button onclick="location.href='compare.html'">ğŸ“„ æŸ¥çœ‹æ”¹å–„å ±å‘Š</button>
      <button onclick="location.href='setting.html'">âš™ï¸ ç³»çµ±è¨­å®š</button>
    </div>

    <!-- ğŸ“Š ç¸½çµ±è¨ˆ -->
<section>
  <h2>ğŸ“Š ä»Šæ—¥ç¢³æ’èˆ‡èƒ½è€—çµ±è¨ˆ</h2>
  <p><span class="label">ä»Šæ—¥è³‡æ–™ç­†æ•¸ï¼š</span><span id="record_count">--</span> ç­†</p>
  <p><span class="label">æœ€å¾Œæ›´æ–°ï¼ˆUTCï¼‰ï¼š</span>${d.timestamp}</p>
  <p><span class="label">ç¸½ç¢³æ’é‡ï¼ˆæ¯æ—¥ï¼‰ï¼š</span><span id="total_emission">--</span> gCOâ‚‚</p>
  <p><span class="label">ç¸½èƒ½è€—ï¼ˆæ¯æ—¥ï¼‰ï¼š</span><span id="total_power">--</span> Wh</p>

  <p><span class="label">æ¯ä»¶ç”¢å“ç¸½èƒ½è€—é‡ï¼ˆç¾¤çµ„ç´¯åŠ ï¼‰ï¼š</span>
    <span id="summary_energy">--</span> Wh â†’ æ¨¡æ“¬å€¼ï¼š<span id="sim_energy">--</span> Wh</p>

  <p><span class="label">æ¯ä»¶ç”¢å“ç¸½ç¢³æ’é‡ï¼ˆç¾¤çµ„ç´¯åŠ ï¼‰ï¼š</span>
    <span id="summary_emission">--</span> gCOâ‚‚ â†’ æ¨¡æ“¬å€¼ï¼š<span id="sim_emission">--</span> gCOâ‚‚</p>

  <p><span class="label">æ¯ä»¶ç”¢å“ç¸½æˆæœ¬ï¼ˆç¾¤çµ„ç´¯åŠ ï¼‰ï¼š</span>
    <span id="summary_cost">--</span> å…ƒ â†’ æ¨¡æ“¬å€¼ï¼š<span id="sim_cost">--</span> å…ƒ</p>

  <p><span class="label">AI å»ºè­°ï¼š</span><span id="ai_tip">--</span></p>
</section>
<!-- ğŸ“‰ æ”¹å–„å‰ vs æ”¹å–„å¾Œ å°æ¯”å€å¡Š -->
<section>
  <h2>ğŸ“‰ æ”¹å–„å‰å¾Œæ•¸æ“šå°æ¯”</h2>
  <table style="width:100%; border-collapse: collapse; margin-top: 1rem;">
    <thead>
      <tr style="background-color: #0077b6; color: white;">
        <th>é …ç›®</th>
        <th>æ”¹å–„å‰ (5/2~5/15)</th>
        <th>æ”¹å–„å¾Œ (5/16~5/20)</th>
        <th>è®ŠåŒ–</th>
      </tr>
    </thead>
    <tbody style="text-align:center;">
      <tr>
        <td>å¹³å‡ç¢³æ’é‡</td>
        <td>83.7 gCOâ‚‚</td>
        <td>61.2 gCOâ‚‚</td>
        <td style="color:green;">â¬‡ 26.9%</td>
      </tr>
      <tr>
        <td>å¹³å‡è‰¯ç‡</td>
        <td>92.3%</td>
        <td>97.4%</td>
        <td style="color:green;">â¬† 5.1%</td>
      </tr>
      <tr>
        <td>å¹³å‡é”æˆç‡</td>
        <td>82.1%</td>
        <td>90.2%</td>
        <td style="color:green;">â¬† 8.1%</td>
      </tr>
      <tr>
        <td>å–®ä»¶å¹³å‡è€—é›»</td>
        <td>125.3 Wh</td>
        <td>101.6 Wh</td>
        <td style="color:green;">â¬‡ 18.9%</td>
      </tr>
    </tbody>
  </table>
  <p style="margin-top: 1rem; color: #007700; font-weight: bold;">
    âœ… æ•¸æ“šé¡¯ç¤ºè¨­å‚™æ”¹å–„å¾Œæ˜é¡¯æå‡æ•ˆç‡ä¸¦é™ä½ç¢³æ’ï¼Œå»ºè­°æ“´å¤§æ­¤æ¨™æº–ä½œæ¥­æµç¨‹ï¼
  </p>
</section>

    <!-- ğŸ“¦ å³æ™‚è¨­å‚™ç‹€æ…‹ -->
    <section>
      <h2>ğŸ“¦ å³æ™‚è¨­å‚™ç‹€æ…‹</h2>
      <div class="grid" id="deviceGrid"></div>
    </section>

    <!-- ğŸ“ˆ åœ–è¡¨ -->
    <section>
      <h2>ğŸ“ˆ èƒ½è€—èˆ‡ç¢³æ’æ¯”è¼ƒåœ–</h2>
      <!-- âœ… è¨­å‚™ç¯©é¸å™¨ -->
  <div style="margin-bottom: 1rem;">
  <label><input type="checkbox" class="device-filter" value="device01" checked> æ¯›å·¾ç¹”æ©Ÿ</label>
  <label><input type="checkbox" class="device-filter" value="device02" checked> å‰–å¸ƒæ©Ÿ</label>
  <label><input type="checkbox" class="device-filter" value="device03" checked> è»Šé‚Šæ©Ÿ</label>
  <label><input type="checkbox" class="device-filter" value="device04" checked> å‰ªé ­æ©Ÿ</label>
  <label><input type="checkbox" class="device-filter" value="device05" checked> æ‘ºé ­æ©Ÿ</label>
  </div>
      <canvas id="barChart"></canvas>
    </section>
    <!-- ğŸ”» Powered by å€å¡Š -->
    <footer style="text-align:center; font-size: 0.85rem; margin-top: 2rem; color: #888;"> 
      Powered by <strong>@SAVE æ™ºæ…§èƒ½æ•ˆç®¡ç†ç³»çµ±</strong>
    </footer>
  </div>
<script>
  const apiBase = "https://atsave-sbir-demo-production.up.railway.app";

  async function loadData() {
    const res = await fetch(apiBase + "/latest");
    const data = await res.json();

    let totalEmission = 0, totalPower = 0;
    const grid = document.getElementById("deviceGrid");
    grid.innerHTML = "";

    const labels = [], powers = [], emissions = [];
    const now = new Date();

    data.forEach(d => {
  const lastUpdate = new Date(d.timestamp);
  const diffMins = Math.floor((now - lastUpdate) / 60000);
  const isOnline = diffMins < 1;
  const statusHTML = isOnline
    ? '<span style="color:green;">ğŸŸ¢ ä¸Šç·š</span>'
    : `<span style="color:red;">ğŸ”´ é›¢ç·šï¼ˆ${diffMins} åˆ†é˜å‰ï¼‰</span>`;

  const limit = parseFloat(localStorage.getItem(`${d.device_id}_limit`) || "80");

  let highlightStyle = "";
  let statusNote = "";

  if (d.emission > limit) {
    highlightStyle = "border: 2px solid red;";
    statusNote = `<p style='color:red;'>âš ï¸ ç¢³æ’éé«˜ï¼Œå·²è¶…å‡ºä¸Šé™ ${limit} gCOâ‚‚</p>`;
  } else if (d.emission < 60) {
    statusNote = "<p style='color:green;'>ğŸ“ˆ ç¯€èƒ½è‰¯å¥½</p>";
  }

  const card = document.createElement("div");
  card.className = "card";
  card.setAttribute("style", highlightStyle);
  card.innerHTML = `
    <h3>ğŸ›  ${mapDevice(d.device_id)} ${statusHTML}</h3>
    <p><span class="label">æœ€å¾Œæ›´æ–°ï¼š</span><br/>
    ğŸ“¦ åŸå§‹è³‡æ–™ï¼š${d.timestamp}<br/>
    ğŸ•’ æœ¬åœ°æ™‚é–“ï¼š${lastUpdate.toLocaleString("zh-TW", { hour12: true })}</p>
    <p><span class="label">å¯ç”¨ç‡ï¼š</span>${d.availability}%</p>
    <p><span class="label">è‰¯ç‡ï¼š</span>${d.quality}%</p>
    <p><span class="label">é”æˆç‡ï¼š</span>${d.performance}%</p>
    <p><span class="label">å–®ä»¶è€—é›»ï¼š</span>${d.power} Wh</p>
    <p><span class="label">å–®ä»¶ç¢³æ’ï¼š</span>${d.emission} gCOâ‚‚</p>
    ${statusNote}
  `;
  grid.appendChild(card);
});
    
    // è¨ˆç®—ç¸½ç­†æ•¸ï¼ˆå‡è¨­æ¯ç­†è¨­å‚™éƒ½æ˜¯ä¸€ç­†è³‡æ–™ï¼‰
document.getElementById("record_count").innerText = data.length;

// å–å¾—æœ€å¾Œä¸€ç­†è³‡æ–™çš„ timestamp
if (data.length > 0) {
  const latest = new Date(Math.max(...data.map(d => new Date(d.timestamp))));
  document.getElementById("last_update").innerText = latest.toLocaleString("zh-TW", { hour12: true });
}
    document.getElementById("total_emission").innerText = totalEmission.toFixed(1);
    document.getElementById("total_power").innerText = totalPower.toFixed(1);
    const aiList = getAiSuggestions(data);
    document.getElementById("ai_tip").innerHTML = "<ul>" + aiList.map(item => `<li>${item}</li>`).join("") + "</ul>";

  function getSelectedDevices() {
  return Array.from(document.querySelectorAll(".device-filter:checked"))
              .map(input => input.value);
}
    
    // ğŸ”´ æ ¹æ“šä½¿ç”¨è€…å‹¾é¸çš„è¨­å‚™éæ¿¾è¦é¡¯ç¤ºçš„åœ–è¡¨è³‡æ–™
const selected = getSelectedDevices();
const filteredLabels = [], filteredPowers = [], filteredEmissions = [];

data.forEach(d => {
  if (selected.includes(d.device_id)) {
    filteredLabels.push(d.device_id);
    filteredPowers.push(d.power);
    filteredEmissions.push(d.emission);
  }
});

drawChart(filteredLabels.map(mapDevice), filteredPowers, filteredEmissions);
    
  }
  
  function mapDevice(id) {
    return {
      device01: "æ¯›å·¾ç¹”æ©Ÿ",
      device02: "å‰–å¸ƒæ©Ÿ",
      device03: "è»Šé‚Šæ©Ÿ",
      device04: "å‰ªé ­æ©Ÿ",
      device05: "æ‘ºé ­æ©Ÿ"
    }[id] || id;
  }

  function getAiSuggestion(totalCarbon) {
    if (totalCarbon > 375) return "ç¢³æ’åé«˜ï¼Œå»ºè­°æª¢æŸ¥é«˜èƒ½è€—å·¥åºä¸¦èª¿æ•´åƒæ•¸ã€‚";
    if (totalCarbon > 320) return "ç¢³æ’é‡ç•¥é«˜ï¼Œå¯è©•ä¼°ç¶­è­·é€±æœŸèˆ‡åŠŸç‡è¨­å®šã€‚";
    return "ç›®å‰ç¢³æ’æ°´æº–åˆç†ï¼Œå»ºè­°ç¶­æŒç¾æœ‰ç¯€èƒ½åƒæ•¸ã€‚";
  }
  
  function getAiSuggestions(data) {
  const suggestions = [];

  // 1. æ‰¾å‡ºç¢³æ’è¶…éä¸Šé™çš„è¨­å‚™
  data.forEach(d => {
    const limit = parseFloat(localStorage.getItem(`${d.device_id}_limit`) || "80");
    if (d.emission > limit) {
      suggestions.push(`å»ºè­°æª¢æŸ¥ ${mapDevice(d.device_id)}ï¼Œç¢³æ’ (${d.emission} gCOâ‚‚) è¶…å‡ºä¸Šé™`);
    }
  });

  // 2. æ‰¾å‡ºé”æˆç‡ < 85 çš„è¨­å‚™
  const lowPerformance = data.filter(d => d.performance < 85);
  lowPerformance.forEach(d => {
    suggestions.push(`ğŸ“‰ ${mapDevice(d.device_id)} é”æˆç‡åä½ (${d.performance}%)`);
  });

  // 3. è‹¥ç¢³æ’ç¸½å€¼åä½ï¼Œå¯åŠ ä¸€å¥æ­£é¢å»ºè­°
  const avgCarbon = data.reduce((sum, d) => sum + d.emission, 0) / data.length;
  if (avgCarbon < 65) {
    suggestions.push("âœ… æœ¬æ—¥ç¯€èƒ½æˆæ•ˆä½³ï¼Œå»ºè­°ç¶­æŒç›®å‰æ“ä½œåƒæ•¸");
  }

  // é™åˆ¶æœ€å¤š 3 æ¢
  return suggestions.slice(0, 3);
}
function calculateCost(power, timestamp) {
  const mode = localStorage.getItem("pricing_mode") || "fixed";

  if (mode === "fixed") {
    const fixedPrice = parseFloat(localStorage.getItem("fixed_price") || "3.5");
    return (power / 1000) * fixedPrice;
  } else {
    // æ™‚é–“é›»åƒ¹æ¨¡å¼
    const hour = new Date(timestamp).getHours();
    const peak = parseFloat(localStorage.getItem("peak_price") || "5");
    const offpeak = parseFloat(localStorage.getItem("offpeak_price") || "2");
    const midpeak = parseFloat(localStorage.getItem("midpeak_price") || "3.5");
    const summerExtra = parseFloat(localStorage.getItem("summer_extra") || "0");

    let rate = offpeak;
    if (hour >= 10 && hour < 17) {
      rate = peak;
    } else if (hour >= 8 && hour < 10 || hour >= 17 && hour < 20) {
      rate = midpeak;
    }

    return (power / 1000) * (rate + summerExtra);
  }
}
  function drawChart(labels, powers, emissions) {
    const ctx = document.getElementById("barChart").getContext("2d");
    if (window.barInstance) window.barInstance.destroy();

    window.barInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "è€—é›»é‡ (Wh)",
            data: powers,
            backgroundColor: "rgba(54, 162, 235, 0.7)"
          },
          {
            label: "ç¢³æ’é‡ (gCOâ‚‚)",
            data: emissions,
            backgroundColor: "rgba(255, 99, 132, 0.7)"
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  function updateNowTime() {
    document.getElementById("nowTime").innerText = new Date().toLocaleTimeString();
  }
    async function fetchSummaryToday() {
  const today = new Date().toISOString().split("T")[0];  // e.g., "2025-05-27"
  const res = await fetch(`${apiBase}/summary-by-date?date=${today}`);
  const data = await res.json();

  document.getElementById("record_count").textContent = data.data_count || 0;
  document.getElementById("total_emission").textContent = data.total_emission || 0;
  document.getElementById("total_power").textContent = data.total_energy || 0;
}
    function loadCarbonFactor() {
  const factor = localStorage.getItem("carbon_factor") || "0.474";
  const updateDate = localStorage.getItem("carbon_factor_date") || "114/4/14";
  const display = `ğŸ”„ é›»åŠ›æ’ç¢³ä¿‚æ•¸ï¼š${factor} kg COâ‚‚e/kWhï¼ˆæ›´æ–°æ—¥æœŸï¼š${updateDate}ï¼‰`;
  document.getElementById("carbonFactorDisplay").innerText = display;
}
  loadData();
  updateNowTime();
  fetchSummaryToday(); 
  setInterval(loadData, 60000);
  setInterval(updateNowTime, 1000);

  loadCarbonFactor();
  // ğŸ”´ æ¯æ¬¡å‹¾é¸è¨­å‚™è®ŠåŒ–å¾Œï¼Œè‡ªå‹•æ›´æ–°åœ–è¡¨è³‡æ–™
document.querySelectorAll(".device-filter").forEach(cb => {
  cb.addEventListener("change", loadData);
});
</script>
</body>
</html>
