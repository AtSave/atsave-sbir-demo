<!DOCTYPE html>
<html lang="zh-TW">
<head>
<link rel="stylesheet" href="style.css" />
  <meta charset="UTF-8" />
  <title>æ­·å²èƒ½æ•ˆæŸ¥è©¢ - æ±å„„æ¯›å·¾</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; padding: 2rem; background: #f0f0f0; color: #333; }
    section { background: #fff; padding: 1.5rem; margin-bottom: 2rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { color: #0077b6; }
    label { margin-right: 0.5rem; }
    table { border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; text-align: center; }
    th { background: #0077b6; color: white; }
  </style>
</head>
<body>
  <h1>ğŸ“š æ±å„„æ¯›å·¾ - æ­·å²èƒ½æ•ˆæŸ¥è©¢</h1>

  <!-- ç¬¬ä¸€æ®µï¼šæ¢ä»¶é¸æ“‡ -->
  <section>
    <h2>ğŸ“… æ­·å²è³‡æ–™æŸ¥è©¢æ¢ä»¶</h2>
    <label for="device">é¸æ“‡æ©Ÿå°ï¼š</label>
    <select id="device">
      <option value="device01">æ¯›å·¾ç¹”æ©Ÿ</option>
      <option value="device02">å‰–å¸ƒæ©Ÿ</option>
      <option value="device03">è»Šé‚Šæ©Ÿ</option>
      <option value="device04">å‰ªé ­æ©Ÿ</option>
      <option value="device05">æ‘ºé ­æ©Ÿ</option>
    </select>
    <label for="start">èµ·å§‹æ—¥æœŸï¼š</label>
    <input type="date" id="start" value="2025-05-05" />
    <label for="end">çµæŸæ—¥æœŸï¼š</label>
    <input type="date" id="end" value="2025-05-10" />
    <button onclick="fetchHistory()">æŸ¥è©¢</button>
  </section>

  <!-- ç¬¬äºŒæ®µï¼šæ­·å²è¡¨æ ¼ -->
  <section>
    <h2>ğŸ“‹ æ­·å²ç´€éŒ„è¡¨</h2>
    <table border="1" width="100%" id="historyTable">
      <thead>
        <tr>
          <th>æ™‚é–“</th>
          <th>å¯ç”¨ç‡ (%)</th>
          <th>è‰¯ç‡ (%)</th>
          <th>é”æˆç‡ (%)</th>
          <th>è€—é›» (Wh)</th>
          <th>ç¢³æ’ (gCOâ‚‚)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ç¬¬ä¸‰æ®µï¼šåœ–è¡¨æ¯”è¼ƒ -->
  <section>
    <h2>ğŸ“ˆ æ­·å²è¶¨å‹¢åœ–</h2>
    <canvas id="trendChart"></canvas>
  </section>

  <script>
    const apiBase = "https://atsave-sbir-demo-production.up.railway.app";

    async function fetchHistory() {
      const device = document.getElementById("device").value;
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;

      const res = await fetch(`${apiBase}/query-logs?device_id=${device}&start=${start}&end=${end}`);
      const data = await res.json();

      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";

      const labels = [], emissions = [], powers = [];

      data.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.timestamp.split("T")[0]} ${d.timestamp.split("T")[1].substring(0,5)}</td>
          <td>${d.availability}</td>
          <td>${d.quality}</td>
          <td>${d.performance}</td>
          <td>${d.power}</td>
          <td>${d.emission}</td>
        `;
        tbody.appendChild(tr);
        labels.push(d.timestamp.split("T")[1].substring(0,5));
        emissions.push(d.emission);
        powers.push(d.power);
      });

      drawTrendChart(labels, powers, emissions);
    }

    function drawTrendChart(labels, power, emission) {
      const ctx = document.getElementById("trendChart").getContext("2d");
      if (window.historyChart) window.historyChart.destroy();

      window.historyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'è€—é›»é‡ (Wh)',
              data: power,
              borderColor: 'rgba(54, 162, 235, 1)',
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              fill: true
            },
            {
              label: 'ç¢³æ’é‡ (gCOâ‚‚)',
              data: emission,
              borderColor: 'rgba(255, 99, 132, 1)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>
</body>
</html>

