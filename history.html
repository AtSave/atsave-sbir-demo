<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ±å„„æ¯›å·¾æœ‰é™å…¬å¸ æ­·å²èƒ½æ•ˆæŸ¥è©¢</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f8f8f8; padding: 2rem; }
    .container { max-width: 1000px; margin: auto; background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.08); }
    h1, h2 { color: #0077b6; }
    label { margin-right: 0.5rem; font-weight: bold; }
    input, select, button { margin: 0.5rem 0.8rem 0.5rem 0; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; }
    button { background-color: #0077b6; color: white; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    th { background-color: #0077b6; color: white; }
    canvas { margin-top: 2rem; }
  </style>
</head>
  <!-- âœ… å…±ç”¨ç¶²ç«™é é¦–å€å¡Š -->
<header style="display: flex; align-items: center; justify-content: space-between; background-color: #ffffff; padding: 1rem 2rem; border-bottom: 1px solid #eee;">
  <div>
    <h1 style="color: #0077b6; margin: 0;">æ±å„„æ¯›å·¾æœ‰é™å…¬å¸ æ™ºæ…§èƒ½æ•ˆå¹³å°</h1>
    <p style="margin: 0; color: #555;">æœ¬å¹³å°æ•´åˆè¨­å‚™ç›£æ§ã€ç¢³æ’è¨ˆç®—èˆ‡ ESG å ±è¡¨åŠŸèƒ½ï¼Œå”åŠ©å·¥å» æ•¸ä½è½‰å‹èˆ‡ç¯€èƒ½ç¢³ç®¡ç†ã€‚</p>
  </div>
  <div>
    <img src="img/atsave-logo.png" alt="ATSAVE LOGO" style="height: 48px;" />
  </div>
</header>

<body>
  <div class="container">
    <!-- ğŸ”µ PDF å ±è¡¨åˆ—å°å°ˆç”¨ LOGO æ¨™é ­ -->
  <div class="logo-header no-print" style="text-align: left; display: none;">
  <img src="img/atsave-logo.png" alt="ATSAVE LOGO" style="height: 50px;" />
  <h1 style="display:inline-block; margin-left: 1rem; color: #0077b6;">ESG èƒ½æ•ˆå ±è¡¨</h1>
  </div>
    <h1>ğŸ“š æ±å„„æ¯›å·¾æœ‰é™å…¬å¸ - æ­·å²èƒ½æ•ˆæŸ¥è©¢</h1>
      
    <!-- ğŸ”™ è¿”å›é¦–é æŒ‰éˆ• -->
    <div style="text-align:right; margin-bottom:1rem;">
      <button onclick="location.href='index.html'">ğŸ  å›åˆ°é¦–é </button>
    </div>

    <!-- ğŸ”¹ æŸ¥è©¢æ¢ä»¶å€ -->
    <section>
      <h2>ğŸ“… æŸ¥è©¢æ¢ä»¶</h2>
      <label for="device">æ©Ÿå°ï¼š</label>
      <select id="device">
        <option value="device01">æ¯›å·¾ç¹”æ©Ÿ</option>
        <option value="device02">å‰–å¸ƒæ©Ÿ</option>
        <option value="device03">è»Šé‚Šæ©Ÿ</option>
        <option value="device04">å‰ªé ­æ©Ÿ</option>
        <option value="device05">æ‘ºé ­æ©Ÿ</option>
      </select>
      <label for="start">é–‹å§‹æ—¥æœŸï¼š</label>
      <input type="date" id="start" value="2025-05-05">
      <label for="end">çµæŸæ—¥æœŸï¼š</label>
      <input type="date" id="end" value="2025-05-10">
      <button onclick="fetchLogs()">æŸ¥è©¢</button>
      <!-- ğŸ”´ æ–°å¢å¿«é€Ÿæ—¥æœŸé¸æ“‡å™¨ -->
      <div style="margin: 1rem 0;">
      <button onclick="setQuickDate(3)">ğŸ“† æœ€è¿‘ä¸‰å¤©</button>
      <button onclick="setQuickDate(7)">ğŸ“† æœ€è¿‘ä¸ƒå¤©</button>
      </div>
    </section>

    <!-- ğŸ”¹ è¡¨æ ¼é¡¯ç¤ºå€ -->
    <section>
      <h2>ğŸ“‹ æ•¸æ“šç´€éŒ„è¡¨</h2>
      <!-- ğŸ”´ åŒ¯å‡ºå ±è¡¨æŒ‰éˆ• -->
    <div style="text-align:right; margin-bottom: 1rem;">
    <button onclick="exportCSV()">â¬‡ åŒ¯å‡º CSV</button>
    <button onclick="window.print()">ğŸ–¨ï¸ åˆ—å° ESG å ±è¡¨ï¼ˆPDFï¼‰</button>
    </div>
      <table id="logTable">
        <thead>
          <tr>
            <th>æ™‚é–“</th>
            <th>å¯ç”¨ç‡</th>
            <th>è‰¯ç‡</th>
            <th>é”æˆç‡</th>
            <th>å–®ä»¶è€—é›» (Wh)</th>
            <th>å–®ä»¶ç¢³æ’ (gCOâ‚‚)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ğŸ”¹ åœ–è¡¨å€ -->
    <section>
      <h2>ğŸ“ˆ èƒ½è€—èˆ‡ç¢³æ’è¶¨å‹¢åœ–</h2>
      <canvas id="trendChart"></canvas>
    </section>
  </div>
<script>
const apiBase = "https://atsave-sbir-demo-production.up.railway.app";

async function fetchLogs() {
  const deviceId = document.getElementById("device").value;
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;

  const res = await fetch(`${apiBase}/query-logs?device_id=${deviceId}&start=${start}&end=${end}`);
  const data = await res.json();

  const tbody = document.querySelector("#logTable tbody");
  tbody.innerHTML = "";

  const timeLabels = [], emissions = [], powers = [];

  data.forEach(d => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${formatTime(d.timestamp)}</td>
      <td>${d.availability}</td>
      <td>${d.quality}</td>
      <td>${d.performance}</td>
      <td>${d.power}</td>
      <td>${d.emission}</td>
    `;
    tbody.appendChild(row);

    timeLabels.push(formatTime(d.timestamp, true));
    emissions.push(d.emission);
    powers.push(d.power);
  });

  drawChart(timeLabels, powers, emissions);
}
  function exportCSV() {
  let csv = "æ™‚é–“,å¯ç”¨ç‡,è‰¯ç‡,é”æˆç‡,è€—é›»(Wh),ç¢³æ’(gCOâ‚‚)\\n";
  document.querySelectorAll("#logTable tbody tr").forEach(row => {
    const values = Array.from(row.querySelectorAll("td")).map(td => td.innerText);
    csv += values.join(",") + "\\n";
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ESG_History_Report.csv";
  a.click();
}

function formatTime(timestamp, short=false) {
  const d = new Date(timestamp);
  const date = d.toISOString().split("T")[0];
  const time = d.toTimeString().split(" ")[0].slice(0,5);
  return short ? time : `${date} ${time}`;
}

function drawChart(labels, powers, emissions) {
  const ctx = document.getElementById("trendChart").getContext("2d");
  if (window.chartInstance) window.chartInstance.destroy();

  window.chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'è€—é›»é‡ (Wh)',
          data: powers,
          borderColor: 'rgba(54,162,235,1)',
          backgroundColor: 'rgba(54,162,235,0.2)',
          fill: true
        },
        {
          label: 'ç¢³æ’é‡ (gCOâ‚‚)',
          data: emissions,
          borderColor: 'rgba(255,99,132,1)',
          backgroundColor: 'rgba(255,99,132,0.2)',
          fill: true
        }
      ]
    },
    options: {
  responsive: true,
  scales: {
    y: { beginAtZero: true }
  },
  plugins: {
    tooltip: {
      mode: "index",
      intersect: false
    }
  }
}
  });
}
  function setQuickDate(days) {
  const today = new Date();
  const start = new Date(today);
  start.setDate(today.getDate() - days + 1); // åŒ…å«ä»Šå¤©

  document.getElementById("start").value = start.toISOString().split("T")[0];
  document.getElementById("end").value = today.toISOString().split("T")[0];
}
</script>
</body>
</html>
